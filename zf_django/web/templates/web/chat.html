{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ìƒë‹´ - ì§‘í• ZIPFIT</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{% static 'css/base.css' %}">
    <link rel="stylesheet" href="{% static 'css/layout.css' %}">
    <link rel="stylesheet" href="{% static 'css/components.css' %}">
    
    <style>
        /* ì§‘í• ë¡œê³  ì•„ë°”íƒ€ ìŠ¤íƒ€ì¼ */
        .message-avatar-zipfit {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #009966 0%, #00a63e 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .message-avatar-zipfit svg {
            width: 24px;
            height: 24px;
        }
        
        /* ì‚¬ìš©ì ì•„ì´ì½˜ ìŠ¤íƒ€ì¼ */
        .message-avatar-user {
            width: 40px;
            height: 40px;
            background: #e4e4e7;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .message-avatar-user svg {
            width: 24px;
            height: 24px;
            color: #52525c;
        }
        
        /* í™˜ì˜ ë©”ì‹œì§€ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .welcome-card {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            border: 1px solid #a7f3d0;
            border-radius: 12px;
            padding: 12px 16px;
            margin-bottom: 0;
            max-width: 460px;
        }

        .welcome-card h2 {
            font-size: 16px;
            font-weight: 700;
            color: #065f46;
            margin-bottom: 2px;
            line-height: 1.2;
        }

        .welcome-card p {
            font-size: 14px;
            color: #047857;
            line-height: 1.3;
            margin: 0;
        }

        .welcome-features {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 2px;
            margin-top: 6px;
        }

        .welcome-feature-item {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 13px;
            color: #065f46;
            line-height: 1.2;
        }

        .welcome-feature-item svg {
            width: 14px;
            height: 14px;
            color: #059669;
            flex-shrink: 0;
        }
        
        /* ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ */
        .loading-message {
            display: flex;
            align-items: center;
            gap: 12px;
            color: #71717b;
            font-size: 14px;
            padding: 16px;
            background: #f4f4f5;
            border-radius: 12px;
            margin: 8px 0;
        }
        
        .loading-dots {
            display: flex;
            gap: 4px;
        }
        
        .loading-dots span {
            width: 8px;
            height: 8px;
            background: #009966;
            border-radius: 50%;
            animation: loadingBounce 1.4s infinite ease-in-out both;
        }
        
        .loading-dots span:nth-child(1) {
            animation-delay: -0.32s;
        }
        
        .loading-dots span:nth-child(2) {
            animation-delay: -0.16s;
        }
        
        @keyframes loadingBounce {
            0%, 80%, 100% {
                transform: scale(0);
            }
            40% {
                transform: scale(1);
            }
        }
        
        /* ì±„íŒ… íˆìŠ¤í† ë¦¬ í´ë¦­ ê°€ëŠ¥í•˜ê²Œ */
        .chat-history-item {
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }

        .chat-history-item:hover {
            background: #f4f4f5;
        }

        .chat-history-content {
            flex: 1;
            min-width: 0;
        }

        .chat-history-content h5 {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .chat-delete-btn {
            opacity: 0;
            transition: opacity 0.2s;
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            flex-shrink: 0;
        }

        .chat-delete-btn:hover {
            background: rgba(239, 68, 68, 0.1);
        }

        .chat-delete-btn svg {
            width: 16px;
            height: 16px;
            color: #ef4444;
        }

        .chat-history-item:hover .chat-delete-btn {
            opacity: 1;
        }

        /* ì±„íŒ… ì…ë ¥ì°½ ë°°ê²½ìƒ‰ ëª…ì‹œì  ì„¤ì • */
        .chat-input-container {
            background: white !important;
        }
        
        .chat-input {
            background: white !important;
            color: #18181b !important;
        }
        
        .chat-input::placeholder {
            color: #9f9fa9 !important;
        }
    </style>
</head>
<body>
    <!-- ëª¨ë°”ì¼ ë©”ë‰´ í† ê¸€ -->
    <button class="mobile-menu-toggle" id="mobileMenuToggle" onclick="toggleSidebar(event)">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
            <path d="M3 12H21" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M3 6H21" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M3 18H21" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
    </button>
    
    <!-- ì‚¬ì´ë“œë°” ì˜¤ë²„ë ˆì´ (ëª¨ë°”ì¼) -->
    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>
    
    <div class="app-container">
        <!-- ì‚¬ì´ë“œë°” -->
        <aside class="sidebar">
            <!-- ì‚¬ì´ë“œë°” í—¤ë” -->
            <div class="sidebar-header">
                <div class="logo-container">
                    <div class="logo-icon">
                        <div class="logo-bg">
                            <svg class="logo-house" viewBox="0 0 20 22" fill="none">
                                <path d="M9.72 0.72L0.72 8.64V20.52H6.12V13.32H13.32V20.52H18.72V8.64L9.72 0.72Z" 
                                      fill="url(#logoGrad1)" 
                                      stroke="url(#logoGrad2)" 
                                      stroke-width="1.44" 
                                      stroke-linejoin="round"/>
                                <defs>
                                    <linearGradient id="logoGrad1" x1="0.72" y1="0.72" x2="18.72" y2="20.52" gradientUnits="userSpaceOnUse">
                                        <stop stop-color="#10B981"/>
                                        <stop offset="1" stop-color="#059669"/>
                                    </linearGradient>
                                    <linearGradient id="logoGrad2" x1="0.72" y1="0.72" x2="18.72" y2="20.52" gradientUnits="userSpaceOnUse">
                                        <stop stop-color="#10B981"/>
                                        <stop offset="1" stop-color="#059669"/>
                                    </linearGradient>
                                </defs>
                            </svg>
                        </div>
                    </div>
                    <div class="logo-text">
                        <h2>ì§‘í•</h2>
                        <p>ZIPFIT</p>
                    </div>
                </div>
            </div>

            <!-- ë„¤ë¹„ê²Œì´ì…˜ -->
            <nav class="sidebar-nav">
                <a href="{% url 'web:main' %}" class="nav-item">
                    <svg viewBox="0 0 20 20" fill="none">
                        <path d="M12.5 17.5V10.8333C12.5 10.6123 12.4122 10.4004 12.2559 10.2441C12.0996 10.0878 11.8877 10 11.6667 10H8.33333C8.11232 10 7.90036 10.0878 7.74408 10.2441C7.5878 10.4004 7.5 10.6123 7.5 10.8333V17.5" stroke="currentColor" stroke-width="1.67" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M2.5 8.33333C2.49994 8.09089 2.55278 7.85135 2.65482 7.63143C2.75687 7.41151 2.90566 7.2165 3.09083 7.06L8.92417 2.06C9.22499 1.80576 9.60613 1.66627 10 1.66627C10.3939 1.66627 10.775 1.80576 11.0758 2.06L16.9092 7.06C17.0943 7.2165 17.2431 7.41151 17.3452 7.63143C17.4472 7.85135 17.5001 8.09089 17.5 8.33333V15.8333C17.5 16.2754 17.3244 16.6993 17.0118 17.0118C16.6993 17.3244 16.2754 17.5 15.8333 17.5H4.16667C3.72464 17.5 3.30072 17.3244 2.98816 17.0118C2.67559 16.6993 2.5 16.2754 2.5 15.8333V8.33333Z" stroke="currentColor" stroke-width="1.67" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <span>í™ˆ</span>
                </a>
                <a href="{% url 'web:chat' %}" class="nav-item active" onclick="clearAnnouncementContext()">
                    <svg viewBox="0 0 20 20" fill="none">
                        <path d="M18.3333 14.1667C18.3333 14.6087 18.1577 15.0326 17.8452 15.3452C17.5326 15.6577 17.1087 15.8333 16.6667 15.8333H5.69C5.24801 15.8334 4.82415 16.0091 4.51167 16.3217L2.67667 18.1567C2.59392 18.2394 2.4885 18.2957 2.37374 18.3186C2.25898 18.3414 2.14003 18.3297 2.03192 18.2849C1.92382 18.2401 1.83142 18.1643 1.7664 18.067C1.70139 17.9697 1.66668 17.8553 1.66667 17.7383V4.16667C1.66667 3.72464 1.84226 3.30072 2.15482 2.98816C2.46738 2.67559 2.89131 2.5 3.33333 2.5H16.6667C17.1087 2.5 17.5326 2.67559 17.8452 2.98816C18.1577 3.30072 18.3333 3.72464 18.3333 4.16667V14.1667Z" stroke="currentColor" stroke-width="1.67" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <span>AI ìƒë‹´</span>
                    <span class="badge">Main</span>
                </a>
                <a href="{% url 'web:list' %}" class="nav-item">
                    <svg viewBox="0 0 20 20" fill="none">
                        <path d="M5 18.3333C4.55797 18.3333 4.13405 18.1577 3.82149 17.8452C3.50893 17.5326 3.33333 17.1087 3.33333 16.6667V3.33334C3.33333 2.89131 3.50893 2.46739 3.82149 2.15482C4.13405 1.84226 4.55797 1.66667 5 1.66667H11.6667C11.9305 1.66624 12.1917 1.718 12.4354 1.81898C12.6791 1.91995 12.9005 2.06814 13.0867 2.255L16.0767 5.245C16.264 5.43126 16.4126 5.65279 16.5139 5.8968C16.6152 6.14082 16.6671 6.40248 16.6667 6.66667V16.6667C16.6667 17.1087 16.4911 17.5326 16.1785 17.8452C15.866 18.1577 15.442 18.3333 15 18.3333H5Z" stroke="currentColor" stroke-width="1.67" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M11.6667 1.66667V5.83333C11.6667 6.05435 11.7545 6.26631 11.9107 6.42259C12.067 6.57887 12.279 6.66667 12.5 6.66667H16.6667" stroke="currentColor" stroke-width="1.67" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M8.33333 7.5H6.66667" stroke="currentColor" stroke-width="1.67" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M13.3333 10.8333H6.66667" stroke="currentColor" stroke-width="1.67" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M13.3333 14.1667H6.66667" stroke="currentColor" stroke-width="1.67" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <span>ê³µê³  ëª©ë¡</span>
                </a>

                <!-- ì±„íŒ… íˆìŠ¤í† ë¦¬ -->
                <div class="chat-history mt-3" id="chatHistoryList">
                    <!-- Chat histories will be loaded here dynamically -->
                </div>
            </nav>

            <!-- ì‚¬ìš©ì ì •ë³´ (í´ë¦­ ì‹œ ìˆ˜ì • í˜ì´ì§€ë¡œ ì´ë™) -->
            <div class="user-info" onclick="window.location.href='{% url 'web:user_info_modify' %}'" style="cursor: pointer;" title="í´ë¦­í•˜ì—¬ ì •ë³´ ìˆ˜ì •">
                <div class="user-avatar" id="userAvatar">ë§¤</div>
                <div class="user-details">
                    <h5 id="userDisplayName">ì‚¬ìš©ì</h5>
                    <p id="userDisplayInfo">ì •ë³´ ì—†ìŒ</p>
                </div>
                <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                    <path d="M4 6L8 10L12 6" stroke="#9F9FA9" stroke-width="1.33" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </div>
        </aside>

        <!-- ë©”ì¸ ì»¨í…ì¸  -->
        <main class="main-content">
            <!-- í—¤ë” -->
            <header class="main-header">
                <div class="header-title">
                    <h1>AI ìƒë‹´</h1>
                    <p>ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?</p>
                </div>
                <div class="header-actions">
                    <span class="badge-lh">LH</span>
                    <span class="badge-sh">SH</span>
                    <span class="badge-gh">GH</span>
                </div>
            </header>

            <!-- ì±„íŒ… ì»¨í…Œì´ë„ˆ -->
            <div class="chat-container">
                <!-- ì¶”ì²œ ì§ˆë¬¸ -->
                <div class="suggested-questions" id="suggestedQuestions">
                    <h3>ì¶”ì²œ ì§ˆë¬¸</h3>
                    <div class="suggestions-grid">
                        <button class="suggestion-card" onclick="askQuestion('ì²­ë…„ ì£¼íƒ ê³µê³ ë¥¼ ì•Œë ¤ì¤˜')">
                            <svg viewBox="0 0 24 24" fill="none">
                                <path d="M3 9L12 2L21 9V20C21 20.5304 20.7893 21.0391 20.4142 21.4142C20.0391 21.7893 19.5304 22 19 22H5C4.46957 22 3.96086 21.7893 3.58579 21.4142C3.21071 21.0391 3 20.5304 3 20V9Z" stroke="#009966" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <p>ì²­ë…„ ì£¼íƒ ê³µê³ ë¥¼ ì•Œë ¤ì¤˜</p>
                        </button>
                        
                        <button class="suggestion-card" onclick="askQuestion('ì‹ í˜¼ë¶€ë¶€ íŠ¹ë³„ê³µê¸‰ ìê²© ì¡°ê±´ì€?')">
                            <svg viewBox="0 0 24 24" fill="none">
                                <path d="M20 21V19C20 17.9391 19.5786 16.9217 18.8284 16.1716C18.0783 15.4214 17.0609 15 16 15H8C6.93913 15 5.92172 15.4214 5.17157 16.1716C4.42143 16.9217 4 17.9391 4 19V21" stroke="#009966" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M16 7C16 9.20914 14.2091 11 12 11C9.79086 11 8 9.20914 8 7C8 4.79086 9.79086 3 12 3C14.2091 3 16 4.79086 16 7Z" stroke="#009966" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <p>ì‹ í˜¼ë¶€ë¶€ íŠ¹ë³„ê³µê¸‰ ìê²© ì¡°ê±´ì€?</p>
                        </button>
                        
                        <button class="suggestion-card" onclick="askQuestion('LH ì²­ì•½ ì‹ ì²­ ë°©ë²• ì•Œë ¤ì¤˜')">
                            <svg viewBox="0 0 24 24" fill="none">
                                <path d="M14 2H6C5.46957 2 4.96086 2.21071 4.58579 2.58579C4.21071 2.96086 4 3.46957 4 4V20C4 20.5304 4.21071 21.0391 4.58579 21.4142C4.96086 21.7893 5.46957 22 6 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V8L14 2Z" stroke="#009966" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M14 2V8H20" stroke="#009966" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <p>LH ì²­ì•½ ì‹ ì²­ ë°©ë²• ì•Œë ¤ì¤˜</p>
                        </button>
                        
                        <button class="suggestion-card" onclick="askQuestion('ì†Œë“ 3ë¶„ìœ„ì— í•´ë‹¹í•˜ëŠ” ì£¼íƒì€?')">
                            <svg viewBox="0 0 24 24" fill="none">
                                <path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" stroke="#009966" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M12 6V12L16 14" stroke="#009966" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <p>ì†Œë“ 3ë¶„ìœ„ì— í•´ë‹¹í•˜ëŠ” ì£¼íƒì€?</p>
                        </button>
                    </div>
                </div>

                <!-- ì±„íŒ… ë©”ì‹œì§€ ì˜ì—­ -->
                <div class="chat-messages" id="chatMessages">
                    <!-- í™˜ì˜ ë©”ì‹œì§€ (ì„¸ì…˜ í‚¤ê°€ ì—†ì„ ë•Œë§Œ í‘œì‹œ) -->
                    <div class="message message-ai" id="welcomeMessage">
                        <div class="message-avatar-zipfit">
                            <svg viewBox="0 0 20 22" fill="none">
                                <path d="M9.72 0.72L0.72 8.64V20.52H6.12V13.32H13.32V20.52H18.72V8.64L9.72 0.72Z" 
                                      fill="white" 
                                      stroke="white" 
                                      stroke-width="1.44" 
                                      stroke-linejoin="round"/>
                            </svg>
                        </div>
                        <div class="message-content welcome-message-content">
                            <div class="welcome-card">
                                <h2>ì•ˆë…•í•˜ì„¸ìš”! ì§‘í• AIì…ë‹ˆë‹¤ ğŸ‘‹</h2>
                                <p>LH, SH, GHì˜ ì‹¤ì œ ê³µê³  ë¬¸ì„œë¥¼ AIê°€ ë¶„ì„í•˜ì—¬ ì •í™•í•˜ê³  ëª…í™•í•œ ë‹µë³€ì„ ì œê³µí•©ë‹ˆë‹¤.</p>
                                
                                <div class="welcome-features">
                                    <div class="welcome-feature-item">
                                        <svg viewBox="0 0 20 20" fill="none">
                                            <path d="M16.6667 9.16667L8.33333 17.5L3.33333 12.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                        <span>ì‹¤ì‹œê°„ ê³µê³  ë¶„ì„</span>
                                    </div>
                                    <div class="welcome-feature-item">
                                        <svg viewBox="0 0 20 20" fill="none">
                                            <path d="M16.6667 9.16667L8.33333 17.5L3.33333 12.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                        <span>ì •í™•í•œ ìê²© í™•ì¸</span>
                                    </div>
                                    <div class="welcome-feature-item">
                                        <svg viewBox="0 0 20 20" fill="none">
                                            <path d="M16.6667 9.16667L8.33333 17.5L3.33333 12.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                        <span>ë§ì¶¤í˜• ì¶”ì²œ</span>
                                    </div>
                                    <div class="welcome-feature-item">
                                        <svg viewBox="0 0 20 20" fill="none">
                                            <path d="M16.6667 9.16667L8.33333 17.5L3.33333 12.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                        <span>24/7 ìƒë‹´ ê°€ëŠ¥</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ì…ë ¥ ì˜ì—­ -->
                <div class="chat-input-container">
                    <form id="chatForm" class="chat-input-form">
                        <input 
                            type="text" 
                            class="chat-input" 
                            id="messageInput"
                            placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." 
                            autocomplete="off"
                        />
                        <button type="submit" class="send-button" id="sendButton">
                            <svg viewBox="0 0 24 24" fill="none">
                                <path d="M22 2L11 13" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M22 2L15 22L11 13L2 9L22 2Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </button>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Marked.js for markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
    <script src="{% static 'js/main.js' %}"></script>
    <script src="{% static 'js/api.js' %}"></script>
    <script src="{% static 'js/mockData.js' %}"></script>
    <script>
        // ============================================
        // ğŸ”¥ ì‚¬ìš©ì ì •ë³´ ê´€ë¦¬ í•¨ìˆ˜ (ì¶”ê°€)
        // ============================================
        
        // ì‚¬ìš©ì ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°
        function getUserInfo() {
            try {
                const savedData = sessionStorage.getItem('userInfo') || localStorage.getItem('userInfo');
                if (savedData) {
                    return JSON.parse(savedData);
                }
                return null;
            } catch (error) {
                console.error('ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì˜¤ë¥˜:', error);
                return null;
            }
        }

        // ì‚¬ìš©ì ì •ë³´ë¥¼ ë°±ì—”ë“œ API í˜•ì‹ìœ¼ë¡œ ë³€í™˜
        function convertUserInfoToAPIFormat(userInfo) {
            if (!userInfo) return {};
            
            return {
                ref_hope_area: userInfo.location || '',           // í¬ë§ ê±°ì£¼ì§€
                ref_age: userInfo.age || 0,                       // ë‚˜ì´
                ref_marriged: userInfo.maritalStatus || 'N',      // ê²°í˜¼ ì—¬ë¶€ (Y/N)
                ref_children: userInfo.children || 0,              // ìë…€ ìˆ˜
                ref_income: userInfo.income || 0                   // ì—°ì†Œë“ (ë§Œì›)
            };
        }

        // ============================================
        // URL íŒŒë¼ë¯¸í„° ë° ì„¸ì…˜ ê´€ë¦¬
        // ============================================
        
        // ì¦‰ì‹œ ì‹¤í–‰: URL íŒŒë¼ë¯¸í„° í™•ì¸ ë° ì´ˆê¸° ì„¤ì •
        (function() {
            const urlParams = new URLSearchParams(window.location.search);
            const sessionIdParam = urlParams.get('session_id');
            
            // ì„¸ì…˜ í‚¤ê°€ ìˆìœ¼ë©´ ì¦‰ì‹œ í™˜ì˜ ë©”ì‹œì§€ ìˆ¨ê¸°ê³  ë¡œë”© ì˜¤ë²„ë ˆì´ í‘œì‹œ
            if (sessionIdParam) {
                // DOMì´ ë¡œë“œë˜ê¸° ì „ì´ë¯€ë¡œ DOMContentLoaded ì´ë²¤íŠ¸ ì‚¬ìš©
                document.addEventListener('DOMContentLoaded', function() {
                    const welcomeMessage = document.getElementById('welcomeMessage');
                    const suggestedQuestions = document.getElementById('suggestedQuestions');
                    const messagesContainer = document.getElementById('chatMessages');
                    const chatContainer = document.querySelector('.chat-container');
                    
                    if (welcomeMessage) {
                        welcomeMessage.style.display = 'none';
                    }
                    if (suggestedQuestions) {
                        suggestedQuestions.style.display = 'none';
                    }
                    
                    // ë¡œë”© ì˜¤ë²„ë ˆì´ ì¦‰ì‹œ í‘œì‹œ
                    if (chatContainer && messagesContainer) {
                        const loadingOverlay = document.createElement('div');
                        loadingOverlay.id = 'chatLoadingOverlay';
                        loadingOverlay.style.cssText = `
                            position: absolute;
                            top: 0;
                            left: 0;
                            right: 0;
                            bottom: 0;
                            background: white;
                            display: flex;
                            flex-direction: column;
                            align-items: center;
                            justify-content: center;
                            z-index: 1000;
                            gap: 16px;
                        `;
                        loadingOverlay.innerHTML = `
                            <div class="loading-dots" style="display: flex; gap: 8px;">
                                <span style="width: 12px; height: 12px; background: #009966; border-radius: 50%; animation: loadingBounce 1.4s infinite ease-in-out both;"></span>
                                <span style="width: 12px; height: 12px; background: #009966; border-radius: 50%; animation: loadingBounce 1.4s infinite ease-in-out both; animation-delay: -0.32s;"></span>
                                <span style="width: 12px; height: 12px; background: #009966; border-radius: 50%; animation: loadingBounce 1.4s infinite ease-in-out both; animation-delay: -0.16s;"></span>
                            </div>
                            <p style="color: #71717b; font-size: 14px; margin: 0;">ì±„íŒ… ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                        `;
                        chatContainer.style.position = 'relative';
                        chatContainer.appendChild(loadingOverlay);
                    }
                });
            }
        })();
        
        // ê³µê³  ì»¨í…ìŠ¤íŠ¸ ì´ˆê¸°í™” í•¨ìˆ˜ (ì‚¬ì´ë“œë°” AI ìƒë‹´ í´ë¦­ ì‹œ í˜¸ì¶œ)
        function clearAnnouncementContext() {
            sessionStorage.removeItem('currentAnnouncementId');
            sessionStorage.removeItem('currentAnnouncementName');
            // ğŸ”¥ ì„¸ì…˜ë„ ì´ˆê¸°í™”í•˜ì—¬ ìƒˆë¡œìš´ ëŒ€í™” ì‹œì‘
            sessionStorage.removeItem('current_session_id');
        }

        // URL íŒŒë¼ë¯¸í„° í™•ì¸
        const urlParams = new URLSearchParams(window.location.search);
        const sessionIdParam = urlParams.get('session_id');
        const announcementName = urlParams.get('announcement');

        // ğŸ”¥ [ì¶”ê°€] ê³µê³  ì»¨í…ìŠ¤íŠ¸ íŒë‹¨ - URL íŒŒë¼ë¯¸í„°ê°€ ìˆì„ ë•Œë§Œ ê³µê³  ëª¨ë“œ
        // (sessionStorageëŠ” ì‚¬ì´ë“œë°” í´ë¦­ ì‹œ ì´ˆê¸°í™”ë˜ë¯€ë¡œ URL íŒŒë¼ë¯¸í„° ìš°ì„ )
        const announcementId = urlParams.get('announcement_id');
        const chatContextType = announcementId ? 'ANNOUNCEMENT' : 'GENERAL';

        // URLì— announcement_idê°€ ìˆìœ¼ë©´ ìƒˆë¡œìš´ ê³µê³  ìƒë‹´ì´ë¯€ë¡œ ì„¸ì…˜ ì´ˆê¸°í™”
        if (announcementId && !sessionIdParam) {
            // ğŸ”¥ ìƒˆë¡œìš´ ê³µê³  ìƒë‹´ ì‹œì‘ ì‹œ ê¸°ì¡´ ì„¸ì…˜ ì´ˆê¸°í™”
            sessionStorage.removeItem('current_session_id');
        }
        
        // URLì— announcement_idê°€ ì—†ìœ¼ë©´ sessionStorageë„ ì •ë¦¬
        if (!announcementId) {
            sessionStorage.removeItem('currentAnnouncementId');
            sessionStorage.removeItem('currentAnnouncementName');
        }
        
        // í˜„ì¬ ì„¸ì…˜ í‚¤ ê´€ë¦¬
        let currentSessionId = sessionIdParam || (typeof getCurrentSessionId !== 'undefined' ? getCurrentSessionId() : null);
        if (!currentSessionId) {
            currentSessionId = sessionStorage.getItem('current_session_id');
            if (!currentSessionId) {
                currentSessionId = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                    const r = Math.random() * 16 | 0;
                    const v = c == 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
                sessionStorage.setItem('current_session_id', currentSessionId);
            }
        }
        if (sessionIdParam) {
            sessionStorage.setItem('current_session_id', sessionIdParam);
        }
        
        // ============================================
        // ì‚¬ìš©ì ì •ë³´ í‘œì‹œ
        // ============================================

        // ì‚¬ìš©ì ì •ë³´ í‘œì‹œ
        function loadUserInfo() {
            try {
                const savedData = sessionStorage.getItem('userInfo') || localStorage.getItem('userInfo');
                const userKey = getOrCreateUserKey();

                // user_keyë¥¼ userIdë¡œ ì‚¬ìš©
                document.getElementById('userDisplayName').textContent = userKey;
                document.getElementById('userAvatar').textContent = userKey.charAt(0);

                if (savedData) {
                    const userInfo = JSON.parse(savedData);

                    let infoText = '';
                    if (userInfo.age) infoText += userInfo.age + 'ì„¸';
                    if (userInfo.location) {
                        if (infoText) infoText += ' Â· ';
                        infoText += userInfo.location;
                    }
                    if (infoText) {
                        document.getElementById('userDisplayInfo').textContent = infoText;
                    }
                }
            } catch (error) {
                console.error('ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        // ============================================
        // ì±„íŒ… ë©”ì‹œì§€ ê´€ë¦¬
        // ============================================
        
        // ì±„íŒ… ë©”ì‹œì§€ ì¶”ê°€ í•¨ìˆ˜
        function addMessage(text, isUser = false) {
            if (!text) {
                console.warn('addMessage: textê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤');
                return;
            }
            
            const messagesContainer = document.getElementById('chatMessages');
            if (!messagesContainer) {
                console.error('addMessage: messagesContainerë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
                return;
            }
            
            const suggestedQuestions = document.getElementById('suggestedQuestions');
            
            // ì¶”ì²œ ì§ˆë¬¸ ìˆ¨ê¸°ê¸°
            if (suggestedQuestions && suggestedQuestions.style.display !== 'none') {
                suggestedQuestions.style.display = 'none';
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'message-user' : 'message-ai'}`;
            
            if (isUser) {
                // ì‚¬ìš©ì ë©”ì‹œì§€ - ì‚¬ëŒ ì•„ì´ì½˜
                const avatar = document.createElement('div');
                avatar.className = 'message-avatar-user';
                avatar.innerHTML = `
                    <svg viewBox="0 0 24 24" fill="none">
                        <path d="M20 21V19C20 17.9391 19.5786 16.9217 18.8284 16.1716C18.0783 15.4214 17.0609 15 16 15H8C6.93913 15 5.92172 15.4214 5.17157 16.1716C4.42143 16.9217 4 17.9391 4 19V21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M12 11C14.2091 11 16 9.20914 16 7C16 4.79086 14.2091 3 12 3C9.79086 3 8 4.79086 8 7C8 9.20914 9.79086 11 12 11Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                `;
                messageDiv.appendChild(avatar);
            } else {
                // AI ë©”ì‹œì§€ - ì§‘í• ë¡œê³ 
                const avatar = document.createElement('div');
                avatar.className = 'message-avatar-zipfit';
                avatar.innerHTML = `
                    <svg viewBox="0 0 20 22" fill="none">
                        <path d="M9.72 0.72L0.72 8.64V20.52H6.12V13.32H13.32V20.52H18.72V8.64L9.72 0.72Z" 
                              fill="white" 
                              stroke="white" 
                              stroke-width="1.44" 
                              stroke-linejoin="round"/>
                    </svg>
                `;
                messageDiv.appendChild(avatar);
            }
            
            const content = document.createElement('div');
            content.className = 'message-content';
            
            // ì‚¬ìš©ì ë©”ì‹œì§€ëŠ” í…ìŠ¤íŠ¸ ê·¸ëŒ€ë¡œ, AI ë©”ì‹œì§€ëŠ” ë§ˆí¬ë‹¤ìš´ íŒŒì‹±
            if (isUser) {
                content.textContent = text;
            } else {
                try {
                    if (typeof marked !== 'undefined') {
                        marked.setOptions({
                            breaks: true,
                            gfm: true,
                            headerIds: false,
                            mangle: false
                        });
                        content.innerHTML = marked.parse(text);
                    } else {
                        content.innerHTML = text.replace(/\n/g, '<br>');
                    }
                } catch (error) {
                    console.error('ë§ˆí¬ë‹¤ìš´ íŒŒì‹± ì˜¤ë¥˜:', error);
                    content.innerHTML = text.replace(/\n/g, '<br>');
                }
            }
            
            messageDiv.appendChild(content);
            
            const beforeCount = messagesContainer.children.length;
            messagesContainer.appendChild(messageDiv);
            const afterCount = messagesContainer.children.length;
            
            const addedMessage = messagesContainer.lastElementChild;
            if (afterCount === beforeCount + 1 && addedMessage === messageDiv) {
                console.log(`âœ“ ë©”ì‹œì§€ ì¶”ê°€ ì„±ê³µ (${beforeCount} â†’ ${afterCount}):`, isUser ? 'ì‚¬ìš©ì' : 'AI', text.substring(0, 30) + '...');
            } else {
                console.error('âœ— ë©”ì‹œì§€ ì¶”ê°€ ì‹¤íŒ¨:', { beforeCount, afterCount, addedMessage, messageDiv, messagesContainer });
            }
            
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // ë¡œë”© ë©”ì‹œì§€ ì¶”ê°€
        function addLoadingMessage(announcementName = null) {
            const messagesContainer = document.getElementById('chatMessages');
            
            if (announcementName === null) {
                const urlParams = new URLSearchParams(window.location.search);
                announcementName = urlParams.get('announcement') || sessionStorage.getItem('currentAnnouncement') || '';
            }
            
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'message message-ai';
            loadingDiv.id = 'loadingMessage';
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar-zipfit';
            avatar.innerHTML = `
                <svg viewBox="0 0 20 22" fill="none">
                    <path d="M9.72 0.72L0.72 8.64V20.52H6.12V13.32H13.32V20.52H18.72V8.64L9.72 0.72Z" 
                          fill="white" 
                          stroke="white" 
                          stroke-width="1.44" 
                          stroke-linejoin="round"/>
                </svg>
            `;
            
            const content = document.createElement('div');
            content.className = 'message-content loading-message';
            
            if (announcementName && announcementName.trim() !== '') {
                content.innerHTML = `
                    <div class="loading-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                    <span>'${announcementName}' ë¬¸ì„œë¥¼ ì°¸ì¡° ì¤‘ì…ë‹ˆë‹¤...</span>
                `;
            } else {
                content.innerHTML = `
                    <div class="loading-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                    <span>ë‹µë³€ì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...</span>
                `;
            }
            
            loadingDiv.appendChild(avatar);
            loadingDiv.appendChild(content);
            messagesContainer.appendChild(loadingDiv);
            
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            return loadingDiv;
        }

        // ë¡œë”© ë©”ì‹œì§€ ì œê±°
        function removeLoadingMessage() {
            const loadingMsg = document.getElementById('loadingMessage');
            if (loadingMsg) {
                loadingMsg.remove();
            }
        }

        // ============================================
        // ğŸ”¥ ì¶”ì²œ ì§ˆë¬¸ í´ë¦­ (ìˆ˜ì •ë¨ - ì‚¬ìš©ì ì •ë³´ í¬í•¨)
        // ============================================
        
        window.askQuestion = async function(question) {
            if (!question || typeof question !== 'string') {
                console.error('Invalid question:', question);
                return;
            }

            addMessage(question, true);

            const urlParams = new URLSearchParams(window.location.search);
            const announcementName = urlParams.get('announcement') || sessionStorage.getItem('currentAnnouncement') || '';

            addLoadingMessage('');

            try {
                const userKey = typeof getOrCreateUserKey !== 'undefined' ? getOrCreateUserKey() : 'user-001';
                const sessionId = typeof getCurrentSessionId !== 'undefined' ? getCurrentSessionId() : currentSessionId || (typeof createSessionId !== 'undefined' ? createSessionId() : 'session-001');

                // ğŸ”¥ ì‚¬ìš©ì ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°
                const userInfo = getUserInfo();
                const userProfile = convertUserInfoToAPIFormat(userInfo);

                // API ìš”ì²­ ë°ì´í„° êµ¬ì„±
                const requestData = {
                    user_message: question,
                    user_key: userKey,
                    session_id: sessionId,
                    // ğŸ”¥ ì‚¬ìš©ì í”„ë¡œí•„ ì •ë³´ ì¶”ê°€
                    ...userProfile
                };

                // ğŸ”¥ ê³µê³  ID ì¶”ê°€ (ìˆëŠ” ê²½ìš°)
                if (announcementId) {
                    requestData.announcement_id = announcementId;
                }

                console.log('API ìš”ì²­ ë°ì´í„°:', requestData);

                const minLoadingTime = new Promise(resolve => setTimeout(resolve, 300));
                const apiCall = typeof API !== 'undefined' && API.sendChatMessage
                    ? API.sendChatMessage(question, userKey, sessionId, userProfile, announcementId)
                    : (typeof callApi !== 'undefined' ? callApi('/api/chat', 'POST', requestData) : Promise.resolve({ status: 'error', message: 'API í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' }));

                const response = await Promise.all([apiCall, minLoadingTime]).then(([result]) => result);

                removeLoadingMessage();

                if (response && response.status === 'success' && response.data && response.data.ai_response) {
                    addMessage(response.data.ai_response.message, false);

                    if (response.data.ai_response.session_id) {
                        const newSessionId = response.data.ai_response.session_id;
                        sessionStorage.setItem('current_session_id', newSessionId);
                        currentSessionId = newSessionId;
                    }

                    await loadChatHistories();
                } else {
                    removeLoadingMessage();
                    addMessage('ì£„ì†¡í•©ë‹ˆë‹¤. ì‘ë‹µì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', false);
                }
            } catch (error) {
                console.error('API í˜¸ì¶œ ì˜¤ë¥˜:', error);
                removeLoadingMessage();
                addMessage('ì£„ì†¡í•©ë‹ˆë‹¤. ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', false);
            }
        }

        // ============================================
        // ğŸ”¥ ì±„íŒ… í¼ ì œì¶œ (ìˆ˜ì •ë¨ - ì‚¬ìš©ì ì •ë³´ í¬í•¨)
        // ============================================
        
        document.getElementById('chatForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const input = document.getElementById('messageInput');
            const message = input.value.trim();

            if (!message) return;

            addMessage(message, true);
            input.value = '';

            addLoadingMessage();

            try {
                const userKey = typeof getOrCreateUserKey !== 'undefined' ? getOrCreateUserKey() : 'user-001';
                const sessionId = typeof getCurrentSessionId !== 'undefined' ? getCurrentSessionId() : currentSessionId || (typeof createSessionId !== 'undefined' ? createSessionId() : 'session-001');

                // ğŸ”¥ ì‚¬ìš©ì ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°
                const userInfo = getUserInfo();
                const userProfile = convertUserInfoToAPIFormat(userInfo);

                // API ìš”ì²­ ë°ì´í„° êµ¬ì„±
                const requestData = {
                    user_message: message,
                    user_key: userKey,
                    session_id: sessionId,
                    // ğŸ”¥ ì‚¬ìš©ì í”„ë¡œí•„ ì •ë³´ ì¶”ê°€
                    ...userProfile
                };

                // ğŸ”¥ ê³µê³  ID ì¶”ê°€ (ìˆëŠ” ê²½ìš°)
                if (announcementId) {
                    requestData.announcement_id = announcementId;
                }

                console.log('API ìš”ì²­ ë°ì´í„°:', requestData);

                const minLoadingTime = new Promise(resolve => setTimeout(resolve, 300));
                const apiCall = typeof API !== 'undefined' && API.sendChatMessage
                    ? API.sendChatMessage(message, userKey, sessionId, userProfile, announcementId)
                    : (typeof callApi !== 'undefined' ? callApi('/api/chat', 'POST', requestData) : Promise.resolve({ status: 'error', message: 'API í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' }));

                const response = await Promise.all([apiCall, minLoadingTime]).then(([result]) => result);

                removeLoadingMessage();

                console.log('[chatForm] API ì‘ë‹µ:', response);

                if (response && response.status === 'success' && response.data && response.data.ai_response) {
                    addMessage(response.data.ai_response.message, false);

                    if (response.data.ai_response.session_id) {
                        const newSessionId = response.data.ai_response.session_id;
                        console.log('[chatForm] ìƒˆ ì„¸ì…˜ ID:', newSessionId);
                        sessionStorage.setItem('current_session_id', newSessionId);
                        currentSessionId = newSessionId;
                    }

                    console.log('[chatForm] loadChatHistories í˜¸ì¶œ...');
                    await loadChatHistories();
                    console.log('[chatForm] loadChatHistories ì™„ë£Œ');
                } else {
                    console.error('[chatForm] ì‘ë‹µ í˜•ì‹ ì˜¤ë¥˜:', response);
                    addMessage('ì£„ì†¡í•©ë‹ˆë‹¤. ì‘ë‹µì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', false);
                }
            } catch (error) {
                console.error('[chatForm] API í˜¸ì¶œ ì˜¤ë¥˜:', error);
                removeLoadingMessage();
                addMessage('ì£„ì†¡í•©ë‹ˆë‹¤. ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', false);
            }
        });

        // ============================================
        // ì±„íŒ… íˆìŠ¤í† ë¦¬ ê´€ë¦¬
        // ============================================
        
        // ì±„íŒ… íˆìŠ¤í† ë¦¬ ë¡œë“œ
        async function loadChatHistory(sessionId) {
            const messagesContainer = document.getElementById('chatMessages');
            const suggestedQuestions = document.getElementById('suggestedQuestions');
            const chatContainer = document.querySelector('.chat-container');
            
            if (!sessionId) return;
            
            const loadingOverlay = document.createElement('div');
            loadingOverlay.id = 'chatLoadingOverlay';
            loadingOverlay.style.cssText = `
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: white;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                z-index: 1000;
                gap: 16px;
            `;
            loadingOverlay.innerHTML = `
                <div class="loading-dots" style="display: flex; gap: 8px;">
                    <span style="width: 12px; height: 12px; background: #009966; border-radius: 50%; animation: loadingBounce 1.4s infinite ease-in-out both;"></span>
                    <span style="width: 12px; height: 12px; background: #009966; border-radius: 50%; animation: loadingBounce 1.4s infinite ease-in-out both; animation-delay: -0.32s;"></span>
                    <span style="width: 12px; height: 12px; background: #009966; border-radius: 50%; animation: loadingBounce 1.4s infinite ease-in-out both; animation-delay: -0.16s;"></span>
                </div>
                <p style="color: #71717b; font-size: 14px; margin: 0;">ì±„íŒ… ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
            `;
            
            if (chatContainer) {
                chatContainer.style.position = 'relative';
                chatContainer.appendChild(loadingOverlay);
            }
            
            try {
                console.log('ì±„íŒ… íˆìŠ¤í† ë¦¬ ë¡œë“œ ì‹œì‘:', sessionId);
                const userKey = typeof getOrCreateUserKey !== 'undefined' ? getOrCreateUserKey() : 'user-001';
                const response = typeof API !== 'undefined' && API.getChatHistoryDetail
                    ? await API.getChatHistoryDetail(sessionId, userKey)
                    : await (typeof callApi !== 'undefined' ? callApi(`/api/chathistories/${sessionId}`, 'GET') : Promise.resolve({ status: 'error', message: 'API í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' }));
                console.log('ì±„íŒ… íˆìŠ¤í† ë¦¬ ì‘ë‹µ:', response);
                
                const allLoadingOverlays = document.querySelectorAll('#chatLoadingOverlay');
                console.log('ë°œê²¬ëœ ë¡œë”© ì˜¤ë²„ë ˆì´ ê°œìˆ˜:', allLoadingOverlays.length);
                allLoadingOverlays.forEach((overlay, index) => {
                    if (overlay.parentNode) {
                        overlay.remove();
                        console.log(`ë¡œë”© ì˜¤ë²„ë ˆì´ ${index + 1} ì œê±°ë¨`);
                    }
                });
                if (loadingOverlay && loadingOverlay.parentNode) {
                    loadingOverlay.remove();
                    console.log('ë¡œë”© ì˜¤ë²„ë ˆì´ ì œê±°ë¨ (backup)');
                }
                
                let chatData = null;
                console.log('ì±„íŒ… íˆìŠ¤í† ë¦¬ ì „ì²´ ì‘ë‹µ:', response);

                // API.getChatHistoryDetailì´ data.dataë¥¼ ë°˜í™˜í•˜ë¯€ë¡œ response.chat_list ì§ì ‘ ì²´í¬
                if (response && response.chat_list && Array.isArray(response.chat_list)) {
                    chatData = response.chat_list;
                } else if (response && response.status === 'success' && response.data) {
                    if (response.data.chat_list && Array.isArray(response.data.chat_list)) {
                        chatData = response.data.chat_list;
                    } else if (Array.isArray(response.data)) {
                        chatData = response.data;
                    } else if (response.data.data && response.data.data.chat_list && Array.isArray(response.data.data.chat_list)) {
                        chatData = response.data.data.chat_list;
                    }
                } else if (response && response.data) {
                    if (response.data.chat_list && Array.isArray(response.data.chat_list)) {
                        chatData = response.data.chat_list;
                    } else if (Array.isArray(response.data)) {
                        chatData = response.data;
                    }
                } else if (Array.isArray(response)) {
                    chatData = response;
                }
                
                console.log('ì¶”ì¶œëœ ì±„íŒ… ë°ì´í„°:', chatData);
                
                if (chatData && chatData.length > 0) {
                    console.log('ì±„íŒ… ë°ì´í„° ë Œë”ë§ ì‹œì‘:', chatData.length, 'ê°œ ë©”ì‹œì§€');
                    
                    const welcomeMessage = document.getElementById('welcomeMessage');
                    if (welcomeMessage) {
                        welcomeMessage.style.display = 'none';
                    }
                    
                    if (!messagesContainer) {
                        console.error('messagesContainerë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
                        if (loadingOverlay.parentNode) {
                            loadingOverlay.remove();
                        }
                        return;
                    }
                    
                    messagesContainer.innerHTML = '';
                    if (suggestedQuestions) {
                        suggestedQuestions.style.display = 'none';
                    }
                    
                    currentSessionId = sessionId;
                    sessionStorage.setItem('current_session_id', sessionId);
                    
                    chatData.forEach((chat, index) => {
                        const isUser = chat.message_type === 'user';
                        console.log(`ë©”ì‹œì§€ ${index + 1}/${chatData.length} ì¶”ê°€:`, isUser ? 'ì‚¬ìš©ì' : 'AI', chat.message.substring(0, 50));
                        addMessage(chat.message, isUser);
                    });
                    
                    setTimeout(() => {
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    }, 100);
                    
                    const allOverlays = document.querySelectorAll('#chatLoadingOverlay');
                    allOverlays.forEach((overlay) => {
                        if (overlay && overlay.parentNode) {
                            overlay.remove();
                        }
                    });
                } else {
                    console.warn('ì±„íŒ… ë°ì´í„°ê°€ ì—†ê±°ë‚˜ ë¹„ì–´ìˆìŠµë‹ˆë‹¤');
                    const existingOverlay = document.getElementById('chatLoadingOverlay');
                    if (existingOverlay && existingOverlay.parentNode) {
                        existingOverlay.remove();
                    }
                    if (loadingOverlay && loadingOverlay.parentNode) {
                        loadingOverlay.remove();
                    }
                }
            } catch (error) {
                console.error('ì±„íŒ… íˆìŠ¤í† ë¦¬ ë¡œë“œ ì˜¤ë¥˜:', error);
                if (loadingOverlay.parentNode) {
                    loadingOverlay.remove();
                }
                messagesContainer.innerHTML = `
                    <div class="message message-ai">
                        <div class="message-avatar-zipfit">
                            <svg viewBox="0 0 20 22" fill="none">
                                <path d="M9.72 0.72L0.72 8.64V20.52H6.12V13.32H13.32V20.52H18.72V8.64L9.72 0.72Z" 
                                      fill="white" 
                                      stroke="white" 
                                      stroke-width="1.44" 
                                      stroke-linejoin="round"/>
                            </svg>
                        </div>
                        <div class="message-content">
                            <p>ì±„íŒ… ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>
                        </div>
                    </div>
                `;
            }
        }

        // ì±„íŒ… ì„¸ì…˜ ë¡œë“œ (íˆìŠ¤í† ë¦¬ í´ë¦­ ì‹œ)
        window.loadChatSession = function(sessionId) {
            sessionStorage.removeItem('currentAnnouncementId');
            sessionStorage.removeItem('currentAnnouncementName');
            window.location.href = `{% url "web:chat" %}?session_id=${sessionId}`;
        };

        // ì±„íŒ… ì„¸ì…˜ ì‚­ì œ
        window.deleteChatSession = async function(event, sessionId) {
            // ì´ë²¤íŠ¸ ì „íŒŒ ì¤‘ì§€ (ë¶€ëª¨ ìš”ì†Œ í´ë¦­ ë°©ì§€)
            event.stopPropagation();

            // ì‚­ì œ í™•ì¸
            if (!confirm('ì´ ì±„íŒ… ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }

            try {
                const userKey = typeof getOrCreateUserKey !== 'undefined' ? getOrCreateUserKey() : 'user-001';

                // API í˜¸ì¶œ
                const response = typeof API !== 'undefined' && API.deleteChatHistory
                    ? await API.deleteChatHistory(sessionId, userKey)
                    : await (typeof deleteChatHistory !== 'undefined' ? deleteChatHistory(sessionId, userKey) : Promise.resolve({ status: 'error', message: 'API í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' }));

                if (response && response.status === 'success') {
                    // í˜„ì¬ ë³´ê³  ìˆëŠ” ì„¸ì…˜ì´ ì‚­ì œëœ ê²½ìš° ë©”ì¸ìœ¼ë¡œ ì´ë™
                    const currentSession = sessionStorage.getItem('current_session_id');
                    if (currentSession === sessionId) {
                        sessionStorage.removeItem('current_session_id');
                        window.location.href = '{% url "web:chat" %}';
                    } else {
                        // íˆìŠ¤í† ë¦¬ ëª©ë¡ë§Œ ìƒˆë¡œê³ ì¹¨
                        await loadChatHistories();
                    }
                } else {
                    alert('ì±„íŒ… ê¸°ë¡ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('ì±„íŒ… ê¸°ë¡ ì‚­ì œ ì˜¤ë¥˜:', error);
                alert('ì±„íŒ… ê¸°ë¡ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        };

        // ì±„íŒ… íˆìŠ¤í† ë¦¬ ëª©ë¡ ë¡œë“œ
        async function loadChatHistories() {
            const chatHistoryList = document.getElementById('chatHistoryList');

            try {
                const userKey = typeof getOrCreateUserKey !== 'undefined' ? getOrCreateUserKey() : 'user-001';
                console.log('[loadChatHistories] userKey:', userKey);

                const response = typeof API !== 'undefined' && API.getChatHistories
                    ? await API.getChatHistories(userKey)
                    : await (typeof callApi !== 'undefined' ? callApi(`/api/chathistories?user_key=${userKey}`, 'GET') : Promise.resolve({ status: 'success', data: [] }));

                console.log('[loadChatHistories] response:', response);

                if (response.status === 'success' && response.data && Array.isArray(response.data)) {
                    console.log('[loadChatHistories] ì±„íŒ… íˆìŠ¤í† ë¦¬ ê°œìˆ˜:', response.data.length);
                    chatHistoryList.innerHTML = '';
                    
                    const newChatItem = document.createElement('div');
                    newChatItem.className = 'chat-history-item';
                    newChatItem.onclick = () => {
                        // ğŸ”¥ ì„¸ì…˜ ë° ê³µê³  ì»¨í…ìŠ¤íŠ¸ ì™„ì „ ì´ˆê¸°í™”
                        sessionStorage.removeItem('current_session_id');
                        sessionStorage.removeItem('currentAnnouncementId');
                        sessionStorage.removeItem('currentAnnouncementName');
                        currentSessionId = null;
                        window.location.href = '{% url "web:chat" %}';
                    };
                    newChatItem.innerHTML = `
                        <div class="chat-history-content">
                            <h5>ìƒˆ ëŒ€í™”</h5>
                            <p>AI ìƒë‹´ì„ ì‹œì‘í•´ë³´ì„¸ìš”</p>
                        </div>
                    `;
                    chatHistoryList.appendChild(newChatItem);

                    response.data.forEach(history => {
                        const historyItem = document.createElement('div');
                        historyItem.className = 'chat-history-item';

                        historyItem.innerHTML = `
                            <div class="chat-history-content" onclick="loadChatSession('${history.session_id}')">
                                <h5>${history.title}</h5>
                                <p>ìµœê·¼ ëŒ€í™”...</p>
                            </div>
                            <button class="chat-delete-btn" onclick="deleteChatSession(event, '${history.session_id}')" title="ì‚­ì œ">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                </svg>
                            </button>
                        `;
                        chatHistoryList.appendChild(historyItem);
                    });
                }
            } catch (error) {
                console.error('ì±„íŒ… íˆìŠ¤í† ë¦¬ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        // ============================================
        // ğŸ”¥ ê³µê³  ì»¨í…ìŠ¤íŠ¸ UI ì—…ë°ì´íŠ¸
        // ============================================

        function updateUIForAnnouncementContext() {
            const announcementName = sessionStorage.getItem('currentAnnouncementName') || 'ì„ íƒí•˜ì‹  ê³µê³ ';
            const welcomeMessage = document.getElementById('welcomeMessage');
            const suggestedQuestions = document.getElementById('suggestedQuestions');

            // ì›°ì»´ ë©”ì‹œì§€ ë³€ê²½
            if (welcomeMessage) {
                const welcomeContent = welcomeMessage.querySelector('.welcome-message-content');
                if (welcomeContent) {
                    welcomeContent.innerHTML = `
                        <div class="welcome-card">
                            <h2>ğŸ  ê³µê³  ìƒë‹´ ëª¨ë“œ</h2>
                            <p style="font-size: 16px; color: #009966; font-weight: 600; margin: 16px 0;">${announcementName}</p>
                            <p>ìœ„ ê³µê³ ì— ëŒ€í•´ ê¶ê¸ˆí•œ ì ì„ ë¬¼ì–´ë³´ì„¸ìš”. ì•„ë˜ ì¶”ì²œ ì§ˆë¬¸ì„ í´ë¦­í•˜ê±°ë‚˜ ì§ì ‘ ì…ë ¥í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

                            <div class="welcome-features">
                                <div class="welcome-feature-item">
                                    <svg viewBox="0 0 20 20" fill="none">
                                        <path d="M16.6667 9.16667L8.33333 17.5L3.33333 12.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                    <span>ê³µê³  ìš”ì•½ ë° ë¶„ì„</span>
                                </div>
                                <div class="welcome-feature-item">
                                    <svg viewBox="0 0 20 20" fill="none">
                                        <path d="M16.6667 9.16667L8.33333 17.5L3.33333 12.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                    <span>ì‹ ì²­ ìê²© í™•ì¸</span>
                                </div>
                                <div class="welcome-feature-item">
                                    <svg viewBox="0 0 20 20" fill="none">
                                        <path d="M16.6667 9.16667L8.33333 17.5L3.33333 12.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                    <span>í•„ìš” ì„œë¥˜ ì•ˆë‚´</span>
                                </div>
                                <div class="welcome-feature-item">
                                    <svg viewBox="0 0 20 20" fill="none">
                                        <path d="M16.6667 9.16667L8.33333 17.5L3.33333 12.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                    <span>ì‹ ì²­ ì¼ì • í™•ì¸</span>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }

            // ì¶”ì²œ ì§ˆë¬¸ ë³€ê²½
            if (suggestedQuestions) {
                const suggestionsGrid = suggestedQuestions.querySelector('.suggestions-grid');
                if (suggestionsGrid) {
                    suggestionsGrid.innerHTML = `
                        <button class="suggestion-card" onclick="askQuestion('ì´ ê³µê³ ë¥¼ ìš”ì•½í•´ì¤˜')">
                            <svg viewBox="0 0 24 24" fill="none">
                                <path d="M14 2H6C5.46957 2 4.96086 2.21071 4.58579 2.58579C4.21071 2.96086 4 3.46957 4 4V20C4 20.5304 4.21071 21.0391 4.58579 21.4142C4.96086 21.7893 5.46957 22 6 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V8L14 2Z" stroke="#009966" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M14 2V8H20" stroke="#009966" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <p>ì´ ê³µê³ ë¥¼ ìš”ì•½í•´ì¤˜</p>
                        </button>

                        <button class="suggestion-card" onclick="askQuestion('ì‹ ì²­ ìê²© ì¡°ê±´ì€?')">
                            <svg viewBox="0 0 24 24" fill="none">
                                <path d="M20 21V19C20 17.9391 19.5786 16.9217 18.8284 16.1716C18.0783 15.4214 17.0609 15 16 15H8C6.93913 15 5.92172 15.4214 5.17157 16.1716C4.42143 16.9217 4 17.9391 4 19V21" stroke="#009966" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M16 7C16 9.20914 14.2091 11 12 11C9.79086 11 8 9.20914 8 7C8 4.79086 9.79086 3 12 3C14.2091 3 16 4.79086 16 7Z" stroke="#009966" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <p>ì‹ ì²­ ìê²© ì¡°ê±´ì€?</p>
                        </button>

                        <button class="suggestion-card" onclick="askQuestion('í•„ìš”í•œ ì„œë¥˜ëŠ” ë­ì•¼?')">
                            <svg viewBox="0 0 24 24" fill="none">
                                <path d="M9 5H7C6.46957 5 5.96086 5.21071 5.58579 5.58579C5.21071 5.96086 5 6.46957 5 7V19C5 19.5304 5.21071 20.0391 5.58579 20.4142C5.96086 20.7893 6.46957 21 7 21H17C17.5304 21 18.0391 20.7893 18.4142 20.4142C18.7893 20.0391 19 19.5304 19 19V7C19 6.46957 18.7893 5.96086 18.4142 5.58579C18.0391 5.21071 17.5304 5 17 5H15" stroke="#009966" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M9 5C9 4.46957 9.21071 3.96086 9.58579 3.58579C9.96086 3.21071 10.4696 3 11 3H13C13.5304 3 14.0391 3.21071 14.4142 3.58579C14.7893 3.96086 15 4.46957 15 5C15 5.53043 14.7893 6.03914 14.4142 6.41421C14.0391 6.78929 13.5304 7 13 7H11C10.4696 7 9.96086 6.78929 9.58579 6.41421C9.21071 6.03914 9 5.53043 9 5Z" stroke="#009966" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <p>í•„ìš”í•œ ì„œë¥˜ëŠ” ë­ì•¼?</p>
                        </button>

                        <button class="suggestion-card" onclick="askQuestion('ì‹ ì²­ ì¼ì •ê³¼ ë°©ë²• ì•Œë ¤ì¤˜')">
                            <svg viewBox="0 0 24 24" fill="none">
                                <path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" stroke="#009966" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M12 6V12L16 14" stroke="#009966" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <p>ì‹ ì²­ ì¼ì •ê³¼ ë°©ë²• ì•Œë ¤ì¤˜</p>
                        </button>
                    `;
                }
            }
        }

        // ============================================
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        // ============================================

        window.addEventListener('load', async function() {
            loadUserInfo();
            await loadChatHistories();

            // ğŸ”¥ ê³µê³  ì»¨í…ìŠ¤íŠ¸ í™•ì¸ ë° UI ë³€ê²½
            if (announcementId && !sessionIdParam) {
                updateUIForAnnouncementContext();
            }

            if (sessionIdParam) {
                await loadChatHistory(sessionIdParam);
            }
        });
        
        // ============================================
        // ì‚¬ì´ë“œë°” í† ê¸€ (ëª¨ë°”ì¼)
        // ============================================
        
        window.toggleSidebar = function(e) {
            if (e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            
            if (sidebar) {
                const isActive = sidebar.classList.contains('show') || sidebar.classList.contains('active');
                
                if (isActive) {
                    sidebar.classList.remove('show');
                    sidebar.classList.remove('active');
                    if (overlay) {
                        overlay.classList.remove('show');
                        overlay.classList.remove('active');
                    }
                } else {
                    sidebar.classList.add('show');
                    sidebar.classList.add('active');
                    if (overlay) {
                        overlay.classList.add('show');
                        overlay.classList.add('active');
                    }
                }
            }
        };
        
        document.addEventListener('DOMContentLoaded', function() {
            const toggleBtn = document.querySelector('.mobile-menu-toggle');
            if (toggleBtn) {
                toggleBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    window.toggleSidebar(e);
                });
                toggleBtn.addEventListener('touchend', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    window.toggleSidebar(e);
                });
            }
        });
    </script>
</body>
</html>